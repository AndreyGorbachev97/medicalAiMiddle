import OpenAI from 'openai';
import { IS_TEST_MODE, OPENAI_KEY } from '../config/env';

export class OpenAIService {
  private openai: OpenAI;
  private readonly MEDICAL_PROMPT = `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –≤—Ä–∞—á-–¥–∏–∞–≥–Ω–æ—Å—Ç. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ –∏ –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

  –ù–∞—á–Ω–∏ –æ—Ç–≤–µ—Ç —Å –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∫—Ä–∞—Ç–∫–æ–≥–æ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  "üëã –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∞—à–∏—Ö –∞–Ω–∞–ª–∏–∑–æ–≤ –∏ –≥–æ—Ç–æ–≤ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –≤–∞–º–∏ —Å–≤–æ–∏–º –∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º."

  –í –æ—Ç–≤–µ—Ç–µ —É–∫–∞–∂–∏:
  1‚É£ –û–±—â—É—é –æ—Ü–µ–Ω–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è
  2‚É£ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–æ–≤:
     - –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –Ω–æ—Ä–º–µ ‚úÖ: –ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç—å –≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, —É–∫–∞–∑–∞—Ç—å —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–¥–µ–ª–∏—Ç—å **–∂–∏—Ä–Ω—ã–º** —à—Ä–∏—Ñ—Ç–æ–º), –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è —Å—Ç–∞–≤–∏—Ç—å ‚úÖ
     - –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –¥–æ–±–∞–≤—å —Ä–∞–∑–¥–µ–ª "–ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏ üîç" –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∫–∞–∂–∏ *–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è* - –∑–Ω–∞—á–µ–Ω–∏–µ - –Ω–æ—Ä–º–∞ - **–Ω–µ –≤ –Ω–æ—Ä–º–µ** - –≤–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è, –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è —Å—Ç–∞–≤–∏—Ç—å ‚ùå
  3‚É£ –ê–Ω–∞–ª–∏–∑ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–µ–π:
     - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏ –≤ —Ä–∞–∑–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö
     - –£–∫–∞–∂–∏, –º–æ–≥—É—Ç –ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –±—ã—Ç—å –ø—Ä–æ—è–≤–ª–µ–Ω–∏–µ–º –æ–¥–Ω–æ–≥–æ –ø–∞—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
     - –û–ø–∏—à–∏, –∫–∞–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç –≤–ª–∏—è—Ç—å –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞
  4‚É£ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º

  –ü—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –æ—Ç –Ω–æ—Ä–º—ã:
  - –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ –ø—Ä–æ—Å—Ç–æ "–∏–Ω—Ñ–µ–∫—Ü–∏—è", –∞ "–±–∞–∫—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–µ–∫—Ü–∏—è" –∏–ª–∏ "–≤–∏—Ä—É—Å–Ω–∞—è –∏–Ω—Ñ–µ–∫—Ü–∏—è")
  - –î–ª—è –≤–æ—Å–ø–∞–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —É—Ç–æ—á–Ω—è–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –∏ –≤–æ–∑–º–æ–∂–Ω—É—é –ø—Ä–∏—á–∏–Ω—É
  - –î–ª—è –≥–æ—Ä–º–æ–Ω–∞–ª—å–Ω—ã—Ö –Ω–∞—Ä—É—à–µ–Ω–∏–π —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞
  - –î–ª—è –∞–Ω–µ–º–∏–π —É—Ç–æ—á–Ω—è–π —Ç–∏–ø (–∂–µ–ª–µ–∑–æ–¥–µ—Ñ–∏—Ü–∏—Ç–Ω–∞—è, B12-–¥–µ—Ñ–∏—Ü–∏—Ç–Ω–∞—è –∏ —Ç.–¥.)
  - –î–ª—è –Ω–∞—Ä—É—à–µ–Ω–∏–π –ª–∏–ø–∏–¥–Ω–æ–≥–æ –æ–±–º–µ–Ω–∞ —É–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –¥–∏—Å–ª–∏–ø–∏–¥–µ–º–∏–∏
  - –î–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤ —Ä–∞–±–æ—Ç–µ –ø–µ—á–µ–Ω–∏ —É—Ç–æ—á–Ω—è–π –≤–æ–∑–º–æ–∂–Ω—É—é –ø—Ä–∏—á–∏–Ω—É (–≤–∏—Ä—É—Å–Ω–∞—è, —Ç–æ–∫—Å–∏—á–µ—Å–∫–∞—è, –∞—É—Ç–æ–∏–º–º—É–Ω–Ω–∞—è –∏ —Ç.–¥.)
  - –î–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤ —Ä–∞–±–æ—Ç–µ –ø–æ—á–µ–∫ —É–∫–∞–∑—ã–≤–∞–π —Ç–∏–ø –Ω–∞—Ä—É—à–µ–Ω–∏—è (–≥–ª–æ–º–µ—Ä—É–ª—è—Ä–Ω–æ–µ, —Ç—É–±—É–ª—è—Ä–Ω–æ–µ –∏ —Ç.–¥.)

  –ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ –¥–µ—Ç–∞–ª—è–º –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –Ω–æ –ø–æ–Ω—è—Ç–Ω—ã–π –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ –∞–Ω–∞–ª–∏–∑.
  –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö —á–∞—Å—Ç–µ–π —Ç–µ–∫—Å—Ç–∞ –∏ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ –ø—É–Ω–∫—Ç–æ–≤.

  –¢–∞–∫–∂–µ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤—å —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏:
  ‚ö†Ô∏è **–í–∞–∂–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ**:
  –î–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º –∏ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞.
  –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–æ—Å—è—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º.
  –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤ –∞–Ω–∞–ª–∏–∑–∞—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º –¥–ª—è –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ—á–Ω–æ–≥–æ –¥–∏–∞–≥–Ω–æ–∑–∞ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ª–µ—á–µ–Ω–∏—è.
  –°–∞–º–æ–ª–µ—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è.`;

  constructor() {
    this.openai = new OpenAI({
      apiKey: OPENAI_KEY,
    });
  }

  public async analyzeMedicalData(text: string, isTestMode?: boolean): Promise<string> {
    try {
      const useTestMode = isTestMode !== undefined ? isTestMode : IS_TEST_MODE;

      const completion = await this.openai.chat.completions.create({
        messages: [
          { role: 'system', content: this.MEDICAL_PROMPT },
          { role: 'user', content: text },
        ],
        model: useTestMode ? 'gpt-3.5-turbo' : 'gpt-4o',
        temperature: 0.7,
        max_tokens: useTestMode ? 2000 : 4000,
      });

      const rawResponse =
        completion.choices[0].message.content ||
        '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
      return rawResponse;
    } catch (error) {
      console.error('Error analyzing medical data:', error);
      throw error;
    }
  }

  public async extractTextFromImage(base64Image: string, _filename?: string): Promise<string> {
    try {
      // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å data:image/...;base64, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const cleanBase64 = base64Image.replace(/^data:image\/[a-zA-Z]+;base64,/, '');

      const completion = await this.openai.chat.completions.create({
        model: 'gpt-4o',
        messages: [
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: '–ò–∑–≤–ª–µ–∫–∏ –≤–µ—Å—å —Ç–µ–∫—Å—Ç –∏–∑ —ç—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –ï—Å–ª–∏ —ç—Ç–æ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∞–Ω–∞–ª–∏–∑—ã, —Å–æ—Ö—Ä–∞–Ω–∏ –∏—Ö –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏. –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –ø—Ä–æ—Å—Ç–æ –∏–∑–≤–ª–µ–∫–∏ –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é.',
              },
              {
                type: 'image_url',
                image_url: {
                  url: `data:image/jpeg;base64,${cleanBase64}`,
                },
              },
            ],
          },
        ],
        max_tokens: 4000,
        temperature: 0.1,
      });

      const extractedText =
        completion.choices[0].message.content || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';

      return extractedText;
    } catch (error) {
      console.error('Error extracting text from image:', error);
      throw error;
    }
  }
}
