import OpenAI from 'openai';
import { IS_TEST_MODE, OPENAI_KEY } from '../config/env';

// ─────────────────────────────────────────────────────────
//  Типы для структурированной работы с результатами
// ─────────────────────────────────────────────────────────

// interface AnalysisResult {
//   /** Отформатированный текст для Telegram */
//   text: string;
//   /** Структурированные данные (для хранения/сравнения) */
//   structured: ExtractedIndicator[] | null;
// }

// interface ExtractedIndicator {
//   name: string;
//   value: number | string;
//   unit: string;
//   refMin: number | null;
//   refMax: number | null;
//   status: 'normal' | 'borderline_low' | 'borderline_high' | 'low' | 'high';
// }

// ─────────────────────────────────────────────────────────
//  Промты
// ─────────────────────────────────────────────────────────

/**
 * Промт для извлечения данных из изображений в структурированном JSON.
 * Структурированный формат снижает потерю данных между этапами.
 */
const EXTRACTION_PROMPT = `Ты — медицинский ассистент. Извлеки ВСЕ данные из предоставленного изображения медицинских анализов.

ФОРМАТ ОТВЕТА — строго JSON, без markdown-обёртки, без пояснений:

{
  "patient": {
    "name": "ФИО",
    "birthDate": "дд.мм.гггг",
    "sex": "муж/жен",
    "sampleDate": "дд.мм.гггг чч:мм"
  },
  "indicators": [
    {
      "name": "Название показателя",
      "value": "значение (число или текст, как в документе)",
      "unit": "единица измерения",
      "refMin": "нижняя граница нормы (число или null)",
      "refMax": "верхняя граница нормы (число или null)",
      "section": "раздел исследования (напр. КЛИНИЧЕСКАЯ БИОХИМИЯ)"
    }
  ]
}

ПРАВИЛА:
- Извлеки КАЖДЫЙ показатель без исключения. Не пропускай ни одного.
- Если значение отсутствует (прочерк, "-"), укажи value: null.
- Числа записывай как числа, без пробелов: 3.44, а не "3,44" — используй точку.
- Если референсные значения указаны диапазоном (напр. "3,5-5,2"), разбей на refMin и refMax.
- Сохраняй оригинальные названия показателей.
- Не добавляй показатели, которых нет в документе.`;

/**
 * Основной медицинский промт.
 * Ключевые отличия от предыдущей версии:
 * - Система трёх зон (норма / пограничное / отклонение)
 * - Не перечисляет все нормальные показатели (экономия токенов, читаемость)
 * - Требует конкретики в диагностических предположениях
 * - Учитывает контекст пользователя (возраст, пол, жалобы)
 */
const MEDICAL_ANALYSIS_PROMPT = `Ты — опытный врач-диагност. Проанализируй результаты медицинских анализов и дай развёрнутый ответ на русском языке.

═══════════════════════════════════
СИСТЕМА ОЦЕНКИ ПОКАЗАТЕЛЕЙ
═══════════════════════════════════

Для каждого числового показателя вычисли его позицию в референсном диапазоне:
  позиция = (значение − нижняя_граница) / (верхняя_граница − нижняя_граница) × 100%

Классификация:
  ❌ ОТКЛОНЕНИЕ — значение ЗА пределами референсного диапазона (позиция < 0% или > 100%)
  ⚠️ ПОГРАНИЧНОЕ — значение в норме, но в крайних 15% диапазона (позиция 0–15% или 85–100%), либо отклонение от границы менее 10%
  ✅ НОРМА — значение уверенно в пределах нормы (позиция 15–85%)

ВАЖНО: Пограничные значения клинически значимы и ВСЕГДА должны комментироваться.
Например, Витамин B12 = 289 при норме 180–914: позиция ≈ 15% — это пограничное значение по нижней границе.

═══════════════════════════════════
ФОРМАТ ОТВЕТА
═══════════════════════════════════

👋 Здравствуйте! Я проанализировал результаты ваших анализов.

1️⃣ **Краткое заключение**
2–3 предложения: общая картина состояния, основные находки, есть ли повод для беспокойства. Упомяни, что N показателей из M в норме.

2️⃣ **Что требует внимания**

Для КАЖДОГО показателя с отклонением или пограничным значением — отдельный блок:

❌ **Название показателя** — X единица (норма: Y–Z) — ОТКЛОНЕНИЕ
→ Что это означает: [простым языком для пациента]
→ Возможные причины: [конкретные, через запятую]

⚠️ **Название показателя** — X единица (норма: Y–Z) — ПОГРАНИЧНОЕ ЗНАЧЕНИЕ (нижняя/верхняя граница)
→ Что это означает: [простым языком]
→ На что обратить внимание: [рекомендация]

3️⃣ **Взаимосвязи**
Как отклонения и пограничные значения связаны между собой. Могут ли быть проявлением единого процесса. Конкретные патофизиологические механизмы.

4️⃣ **Рекомендации**
Конкретные действия, расставленные по приоритету:
🔴 Срочно: ...
🟡 В ближайшее время: ...
🟢 При возможности: ...

Укажи конкретные дополнительные анализы/обследования, которые помогут уточнить картину.

═══════════════════════════════════
ПРАВИЛА
═══════════════════════════════════

- Используй ТОЛЬКО данные из предоставленных документов. Не додумывай значения.
- Если показатель не читается или отсутствует — укажи это явно.
- Будь конкретен в диагностических предположениях:
  • Не "инфекция", а "вирусная инфекция" / "бактериальная инфекция"
  • Не "анемия", а "железодефицитная анемия" / "B12-дефицитная анемия"
  • Не "воспаление", а конкретная локализация и возможная причина
- НЕ перечисляй показатели в норме по одному — только общее упоминание в заключении.
- Если предоставлены данные из нескольких документов — анализируй их СОВМЕСТНО.
- Если пользователь указал жалобы, возраст, препараты — учитывай их в интерпретации.
- Язык: понятный пациенту, но без упрощения до потери медицинского смысла.

Также в конце ответа добавь следующие строки:
⚠️ **Важное предупреждение**:
Данный анализ является предварительным и не заменяет консультацию квалифицированного врача. Все рекомендации носят информационный характер и не являются медицинским назначением. При наличии отклонений обязательно проконсультируйтесь с врачом. Самолечение может быть опасно для здоровья.`;


export class OpenAIService {
  private openai: OpenAI;

  constructor() {
    this.openai = new OpenAI({
      apiKey: OPENAI_KEY,
    });
  }

  // ═══════════════════════════════════════════════════════
  //  Основной метод: анализ текстовых данных анализов
  // ═══════════════════════════════════════════════════════

  /**
   * Анализирует текстовые данные медицинских анализов.
   *
   * @param text - Извлечённый текст из документов (один или несколько)
   * @param userContext - Дополнительный контекст от пользователя (жалобы, возраст, препараты)
   * @param isTestMode - Использовать ли тестовый режим (gpt-3.5-turbo)
   */
  public async analyzeMedicalData(
    text: string,
    userContext?: string,
    isTestMode?: boolean,
  ): Promise<string> {
    try {
      const useTestMode = isTestMode !== undefined ? isTestMode : IS_TEST_MODE;

      // Формируем сообщение пользователя с контекстом
      let userMessage = `Данные анализов:\n\n${text}`;
      if (userContext) {
        userMessage += `\n\n📝 Дополнительная информация от пациента:\n${userContext}`;
      }

      console.log('useTestMode', useTestMode);
      const completion = await this.openai.chat.completions.create({
        messages: [
          { role: 'system', content: MEDICAL_ANALYSIS_PROMPT },
          { role: 'user', content: userMessage },
        ],
        model: useTestMode ? 'gpt-4o-mini' : 'gpt-4o',
        temperature: 0.25, // Низкая температура для медицинской точности
        max_tokens: useTestMode ? 4000 : 10000, // Увеличено: старые 4000 не хватало
      });

      const rawResponse =
        completion.choices[0].message.content ||
        'Не удалось получить анализ. Пожалуйста, попробуйте ещё раз.';

      return rawResponse;
    } catch (error) {
      console.error('Error analyzing medical data:', error);
      throw error;
    }
  }

  // ═══════════════════════════════════════════════════════
  //  Извлечение текста из изображений (структурированное)
  // ═══════════════════════════════════════════════════════

  /**
   * Извлекает данные из изображения в структурированном JSON-формате.
   * Это снижает потери данных при передаче между этапами.
   *
   * @param base64Image - Base64-закодированное изображение
   * @returns JSON-строка с извлечёнными данными
   */
  public async extractTextFromImage(base64Image: string): Promise<string> {
    try {
      const cleanBase64 = base64Image.replace(/^data:image\/[a-zA-Z]+;base64,/, '');

      const completion = await this.openai.chat.completions.create({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: EXTRACTION_PROMPT,
          },
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: 'Извлеки все данные из этого медицинского документа в JSON-формате.',
              },
              {
                type: 'image_url',
                image_url: {
                  url: `data:image/jpeg;base64,${cleanBase64}`,
                },
              },
            ],
          },
        ],
        max_tokens: 4000,
        temperature: 0.05, // Минимальная температура для точного извлечения
        response_format: { type: 'json_object' }, // Гарантирует JSON-ответ
      });

      const extractedText =
        completion.choices[0].message.content || '{"error": "Не удалось извлечь данные"}';

      return extractedText;
    } catch (error) {
      console.error('Error extracting text from image:', error);
      throw error;
    }
  }

  // ═══════════════════════════════════════════════════════
  //  Комбинированный анализ: изображение → анализ (1 запрос)
  // ═══════════════════════════════════════════════════════

  /**
   * Отправляет изображения напрямую в аналитическую модель.
   * Объединяет извлечение и анализ в один запрос, что:
   * - Снижает количество галлюцинаций
   * - Убирает потерю данных между этапами
   * - Экономит один API-вызов (и деньги)
   *
   * @param base64Images - Массив base64-изображений (до 3 штук)
   * @param userContext - Контекст от пользователя
   */
  public async analyzeImagesDirectly(
    base64Images: string[],
    userContext?: string,
  ): Promise<string> {
    try {
      const imageContents = base64Images.map((img) => {
        const cleanBase64 = img.replace(/^data:image\/[a-zA-Z]+;base64,/, '');
        return {
          type: 'image_url' as const,
          image_url: {
            url: `data:image/jpeg;base64,${cleanBase64}`,
            detail: 'high' as const, // Высокое разрешение для медицинских документов
          },
        };
      });

      const textParts: Array<{ type: 'text'; text: string }> = [
        {
          type: 'text' as const,
          text: userContext
            ? `Проанализируй медицинские анализы на изображениях.\n\n📝 Дополнительная информация от пациента:\n${userContext}`
            : 'Проанализируй медицинские анализы на изображениях.',
        },
      ];

      const completion = await this.openai.chat.completions.create({
        model: 'gpt-4o',
        messages: [
          {
            role: 'system',
            content: MEDICAL_ANALYSIS_PROMPT,
          },
          {
            role: 'user',
            content: [...textParts, ...imageContents],
          },
        ],
        max_tokens: 10000,
        temperature: 0.25,
      });

      const rawResponse =
        completion.choices[0].message.content ||
        'Не удалось получить анализ. Пожалуйста, попробуйте ещё раз.';

      return rawResponse;
    } catch (error) {
      console.error('Error analyzing images directly:', error);
      throw error;
    }
  }
}
